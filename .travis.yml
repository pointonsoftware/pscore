# Copyright (C) Pointon Software - All Rights Reserved
# Unauthorized copying of this file, via any medium is strictly prohibited
# Proprietary and confidential
# Written by Ben Ziv <pointonsoftware@gmail.com>, August 2020

# Configuration
language: cpp
compiler: gcc
dist: bionic

env:
  global:
    # include $HOME/.local/bin for `aws`
    - PATH=$HOME/.local/bin:$PATH

before_install:
  - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
  - sudo apt-get update -qq
  # S3 setup
  - pyenv global 3.7.1
  - pip install -U pip
  - pip install awscli
  - mkdir -p ~/$TRAVIS_BUILD_NUMBER
  - aws s3 sync s3://travis-build-stages-shared-storage-test/$TRAVIS_BUILD_NUMBER ~/$TRAVIS_BUILD_NUMBER

install:
  - sudo apt-get install cmake
  - sudo apt-get install cppcheck
  - sudo apt-get install -qq g++-7
  - sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-7 90

#stages:
  #- Static code analysis
  #- Compile
  #- unittest
  #- Profile

jobs:
  include:
    - stage  : Static code analysis
      name   : CppLint
      script : >-
               travis_retry wget --quiet -O - https://raw.githubusercontent.com/cpplint/cpplint/master/cpplint.py |
               python - --filter=-readability/multiline_comment,-whitespace/ending_newline,-build/c++11
               --linelength=100 --recursive application databoundary domain utility

    - name   : CppCheck
      script : >-
              cppcheck --quiet --error-exitcode=1 --enable=warning,performance,information,style
              --suppress=missingIncludeSystem --check-config
              application databoundary domain utility -idomain/unittest

    - stage  : Compile
      name   : Build
      script : ci/ci_build.sh

    - stage  : Unit Test
      name   : Unit Test
      script : ci/ci_unittest.sh

    - stage  : Profile
      name   : gprof
      script : ci/ci_profiling.sh

      after_success:
        - aws s3 rm --recursive s3://travis-build-stages-shared-storage-test/$TRAVIS_BUILD_NUMBER # clean up after ourselves

after_success:
  - echo "Successful!"
  - aws s3 sync ~/$TRAVIS_BUILD_NUMBER s3://travis-build-stages-shared-storage-test/$TRAVIS_BUILD_NUMBER

after_failure:
  - echo "Failed!"

# Currently not used
#deploy:
#  github-token: $GITHUB_TOKEN