# Copyright (C) Pointon Software - All Rights Reserved
# Unauthorized copying of this file, via any medium is strictly prohibited
# Proprietary and confidential
# Written by Ben Ziv <pointonsoftware@gmail.com>, December 2020
# -r . -e orchestra -e external -e utility -e core/entity -e core/validator --gcov-options '\-lp'

name: Linux

on: [pull_request]

jobs:
  build:
    name:  Ubuntu 18.04
    runs-on: ubuntu-18.04

    steps:
    - name: Code checkout
      uses: actions/checkout@v2
      with:
        submodules: recursive

    - name: CppLint
      run: |
       pip install wheel
       pip install cpplint
       python -m cpplint --filter=-readability/multiline_comment,-whitespace/ending_newline,-build/c++11 --linelength=100 --recursive core orchestra mock utility

    - name: CppCheck
      run: |
       sudo apt-get install cppcheck
       cppcheck --std=c++11 --enable=warning,style,performance,portability,information --suppress=missingIncludeSystem --error-exitcode=1 --inline-suppr core orchestra mock utility -icore/domain/unittest

    - name: Build
      run  : |
       sudo apt-get install cmake
       sudo apt-get install -qq g++-7
       sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-7 90
       ./ci/ci_build.sh

    - name: Unit test
      run  : ./ci/ci_unittest.sh

    - name: Code Coverage CodeCov
      run  : |
       gcov core/*.cpp -o core/
       bash <(curl -s https://codecov.io/bash) || echo "Codecov did not collect coverage reports"

    - name: Generate coverage report
      run: |
       rm -rf coverage_report
       ./ci/ci_unittest.sh
       gcov core/*.cpp -o core/
       lcov --directory ./ --capture --output-file lcov_tmp.info -b ./
       lcov --extract lcov_tmp.info "$(pwd)/*" --output-file lcov.info
       genhtml lcov.info -o coverage_report --frame --legend --demangle-cpp

    - uses: actions/upload-artifact@v2
      with:
       name: Coverage results
       path: coverage_report

    - name: Profile
      run  : ./ci/ci_profiling.sh